<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PDF Êü•ÁúãÂô®</title>
    <link rel="stylesheet" href="/static/lib/pdf_viewer.min.css">
    <style>
        :root {
            --bg: #0f172a;
            --panel: #111827;
            --accent: #38bdf8;
            --text: #e5e7eb;
            --muted: #94a3b8;
            --border: #1f2937;
            --hover: rgba(56, 189, 248, 0.1);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html, body { 
            width: 100%; 
            height: 100%; 
            background: radial-gradient(circle at 20% 20%, rgba(56, 189, 248, 0.08), transparent 25%),
                        radial-gradient(circle at 80% 0%, rgba(52, 211, 153, 0.08), transparent 20%),
                        var(--bg);
            color: var(--text);
            font-family: "Segoe UI", "Helvetica Neue", Arial, sans-serif;
            overflow: hidden;
        }
        
        #toolbar { 
            height: 56px;
            background: rgba(17, 24, 39, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 100;
            position: relative;
        }
        
        #toolbar button, #toolbar input { 
            padding: 8px 16px;
            border: 1px solid var(--border);
            background: var(--panel);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            height: 36px;
            color: var(--text);
            transition: all 0.2s ease;
        }
        
        #toolbar button:hover { 
            background: var(--hover);
            border-color: var(--accent);
            transform: translateY(-1px);
        }
        
        #toolbar button:active {
            transform: translateY(0);
        }
        
        #toolbar button:disabled { 
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
        }
        
        #toolbar input { 
            width: 70px;
            text-align: center;
            background: var(--bg);
        }
        
        #toolbar span {
            color: var(--muted);
            font-size: 14px;
        }
        
        #current-page-display {
            color: var(--accent);
            font-weight: 600;
        }
        
        .sep { 
            width: 1px;
            height: 28px;
            background: var(--border);
            margin: 0 6px;
        }
        
        #container { 
            position: absolute;
            top: 56px;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            overflow-x: hidden;
            background: var(--bg);
            padding: 20px;
        }
        
        /* Ëá™ÂÆö‰πâÊªöÂä®Êù° */
        #container::-webkit-scrollbar {
            width: 12px;
        }
        
        #container::-webkit-scrollbar-track {
            background: var(--panel);
            border-left: 1px solid var(--border);
        }
        
        #container::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 6px;
            border: 2px solid var(--panel);
        }
        
        #container::-webkit-scrollbar-thumb:hover {
            background: var(--muted);
        }
        
        #pages-container { 
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
            min-height: 100%;
        }
        
        .page-wrapper {
            position: relative;
            background: white;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6),
                        0 0 0 1px rgba(56, 189, 248, 0.1);
            border-radius: 4px;
            overflow: hidden;
            /* Á¶ÅÁî®ÊÇ¨ÂÅú‰ΩçÁßª‰ª•Èò≤Èº†Ê†áÁßªÂä®Êó∂È°µÈù¢ÊäñÂä® */
            transition: box-shadow 0.2s ease;
        }
        
        .page-wrapper:hover {
            box-shadow: 0 12px 40px rgba(0,0,0,0.7),
                        0 0 0 1px rgba(56, 189, 248, 0.3);
        }
        
        .page-canvas { display: block; }
        
        .textLayer { 
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            line-height: 1.0;
            opacity: 1;
        }
        
        .textLayer > span,
        .textLayer > div { 
            /* ÈªòËÆ§PDF.jsËÆ©ÊñáÊú¨ÈÄèÊòéÔºå‰ªÖÁî®‰∫éÈÄâ‰∏≠Ôºå‰ΩÜÊàë‰ª¨ÈúÄË¶ÅÂØπÈ´ò‰∫ÆËØçÊòæÁ§∫È¢úËâ≤ */
            color: transparent;
            text-shadow: none;
            position: absolute;
            white-space: pre;
            cursor: text;
            transform-origin: 0% 0%;
        }

        /* È´ò‰∫Æ/ÁîüËØçspan Âº∫Âà∂ÊòæÁ§∫È¢úËâ≤ÔºåË¶ÜÁõñÈÄèÊòéÊñáÊú¨ */
        .textLayer > span.pdf-vocab-highlight,
        .textLayer > div.pdf-vocab-highlight {
            color: #1e3a8a !important;
            text-shadow: 0 0 0 #1e3a8a !important;
        }
        .textLayer > span.pdf-vocab-word,
        .textLayer > div.pdf-vocab-word {
            color: #0f172a !important;
            text-shadow: 0 0 0 #0f172a !important;
        }
        
        .textLayer ::selection { 
            background: rgba(56, 189, 248, 0.5);
        }
        
        .textLayer::-moz-selection { 
            background: rgba(56, 189, 248, 0.5);
        }
        
        .annotationLayer { 
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
        }
        
        #loading { 
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(17, 24, 39, 0.98);
            backdrop-filter: blur(12px);
            color: var(--text);
            padding: 40px 60px;
            border-radius: 12px;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 16px;
            z-index: 1000;
            border: 1px solid var(--border);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        
        .spinner { 
            width: 48px;
            height: 48px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error { 
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(244, 63, 94, 0.95);
            backdrop-filter: blur(12px);
            color: white;
            padding: 24px 48px;
            border-radius: 12px;
            display: none;
            z-index: 1000;
            max-width: 80%;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        
        .page-number { 
            position: absolute;
            top: -36px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(17, 24, 39, 0.95);
            backdrop-filter: blur(8px);
            color: var(--accent);
            padding: 6px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            border: 1px solid var(--border);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        /* È°µÈù¢Âç†‰ΩçÁ¨¶Ê†∑Âºè */
        .page-placeholder {
            position: relative;
            background: rgba(30, 41, 59, 0.3);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            margin: 24px 0;
            transition: opacity 0.3s ease;
        }
        
        .page-placeholder:hover {
            background: rgba(30, 41, 59, 0.5);
        }
        
        /* ÂàíËØçÊ∞îÊ≥°Ê†∑Âºè - ÂåπÈÖç‰∏ªÂ∫îÁî®È£éÊ†º */
        .vocab-bubble { 
            position: fixed;
            background: rgba(11, 18, 33, 0.98);
            border: 2px solid var(--accent);
            border-radius: 8px;
            padding: 12px 14px;
            box-shadow: 0 6px 30px rgba(56, 189, 248, 0.4), 0 0 20px rgba(56, 189, 248, 0.2);
            z-index: 10000;
            min-width: 160px;
            max-width: 280px;
            animation: bubbleIn 120ms ease cubic-bezier(0.34, 1.56, 0.64, 1);
            backdrop-filter: blur(10px);
            pointer-events: auto;
            will-change: transform, opacity;
        }
        
        @keyframes bubbleIn {
            from {
                opacity: 0;
                transform: scale(0.85) translateY(8px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .vocab-bubble .bubble-word { 
            font-weight: 700;
            color: #38bdf8;
            font-size: 15px;
            margin-bottom: 8px;
            border-bottom: 1px solid rgba(56, 189, 248, 0.3);
            padding-bottom: 8px;
            word-break: break-word;
        }
        
        .vocab-bubble .bubble-meaning { 
            color: #cbd5e1;
            font-size: 13px;
            margin-bottom: 6px;
            line-height: 1.5;
            max-height: 60px;
            overflow-y: auto;
        }
        
        .vocab-bubble .bubble-note { 
            color: #a7f3d0;
            font-size: 12px;
            margin-bottom: 8px;
            line-height: 1.4;
            padding: 6px;
            background: rgba(34, 211, 153, 0.1);
            border-left: 2px solid rgba(34, 211, 153, 0.5);
            border-radius: 2px;
        }
        
        .vocab-bubble .bubble-buttons { 
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .vocab-bubble .bubble-note-btn { 
            width: 100%;
            padding: 8px 10px;
            background: linear-gradient(135deg, rgba(34, 211, 153, 0.15), rgba(56, 189, 248, 0.1));
            border: 1px solid rgba(34, 211, 153, 0.6);
            color: #6ee7b7;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 100ms ease;
            user-select: none;
        }
        
        .vocab-bubble .bubble-note-btn:hover { 
            background: linear-gradient(135deg, rgba(34, 211, 153, 0.3), rgba(56, 189, 248, 0.2));
            border-color: #34d399;
            color: #d1fae5;
            box-shadow: 0 0 12px rgba(34, 211, 153, 0.3);
        }
        
        .vocab-bubble .bubble-note-btn:active {
            transform: scale(0.98);
        }
        
        /* Ê∞îÊ≥°ÁºñËæëË°®Âçï */
        .bubble-edit-form { 
            margin-top: 10px;
        }
        
        .bubble-form-group { 
            margin-bottom: 10px;
        }

        .bubble-form-group label {
            display: block;
            font-size: 11px;
            color: #94a3b8;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .bubble-input,
        .bubble-textarea { 
            width: 100%;
            padding: 8px 10px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(56, 189, 248, 0.3);
            border-radius: 4px;
            color: #e2e8f0;
            font-size: 13px;
            font-family: inherit;
            transition: all 150ms ease;
            resize: vertical;
        }
        
        .bubble-input:focus,
        .bubble-textarea:focus {
            outline: none;
            border-color: #38bdf8;
            background: rgba(15, 23, 42, 0.8);
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.1);
        }
        
        .bubble-textarea {
            min-height: 50px;
            line-height: 1.4;
        }
        
        .bubble-buttons { 
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .bubble-save-btn,
        .bubble-cancel-btn { 
            flex: 1;
            padding: 8px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 100ms ease;
            user-select: none;
        }
        
        .bubble-save-btn { 
            background: linear-gradient(135deg, rgba(34, 211, 153, 0.2), rgba(56, 189, 248, 0.15));
            border: 1px solid rgba(34, 211, 153, 0.6);
            color: #6ee7b7;
        }
        
        .bubble-save-btn:hover { 
            background: linear-gradient(135deg, rgba(34, 211, 153, 0.3), rgba(56, 189, 248, 0.2));
            border-color: #34d399;
            color: #d1fae5;
            box-shadow: 0 0 12px rgba(34, 211, 153, 0.3);
        }
        
        .bubble-save-btn:active {
            transform: scale(0.97);
        }
        
        .bubble-cancel-btn { 
            background: rgba(248, 113, 113, 0.1);
            border: 1px solid rgba(248, 113, 113, 0.4);
            color: #fca5a5;
        }
        
        .bubble-cancel-btn:hover { 
            background: rgba(248, 113, 113, 0.2);
            border-color: #f87171;
            color: #fecaca;
            box-shadow: 0 0 12px rgba(248, 113, 113, 0.2);
        }
        
        .bubble-cancel-btn:active {
            transform: scale(0.97);
        }
        
        /* PDFËØçÊ±áÈ´ò‰∫ÆÂíåÊµÆÁ™ó - ‰∏éÊñáÊú¨ÈòÖËØªÂíåÂ≠óÂπï‰∏ÄËá¥ */
        
        /* Â∑≤Ê∑ªÂä†ÊâπÊ≥®ÁöÑËØç - ÈªÑËâ≤È´ò‰∫ÆÔºàÊúÄÈÜíÁõÆÁöÑÊñπÊ°àÔºâ */
        .pdf-vocab-highlight {
            background: #ffeb3b !important;  /* ÊòéÈªÑËâ≤ÔºåÁî®!importantÁ°Æ‰øùÂ∫îÁî® */
            cursor: pointer;
            color: #000;
            transition: all 150ms ease;
            padding: 0;
            margin: 0;
            border-radius: 1px;
            box-shadow: none;
            text-decoration-line: underline;
            text-decoration-style: wavy;
            text-decoration-color: #f59e0b;
            text-decoration-thickness: 1px;
            text-underline-offset: 1px;
            text-decoration-skip-ink: none;
            text-decoration-skip: none;
            line-height: inherit;
        }
        
        .pdf-vocab-highlight:hover {
            background: linear-gradient(180deg, transparent 30%, rgba(255, 230, 92, 0.5) 30%, rgba(255, 230, 92, 0.5) 80%, transparent 80%) !important;
            color: #000;
        }
        
        /* Êú™Ê∑ªÂä†ÊâπÊ≥®ÁöÑËØç - ËΩªÂæÆÈ´ò‰∫Æ */
        .pdf-vocab-word {
            cursor: pointer;
            transition: all 150ms ease;
            position: relative;
            padding: 0;
            margin: 0;
            line-height: inherit;
            text-decoration-line: underline;
            text-decoration-style: wavy;
            text-decoration-color: #60a5fa;
            text-decoration-thickness: 1px;
            text-underline-offset: 1px;
            text-decoration-skip-ink: none;
            text-decoration-skip: none;
        }
        
        .pdf-vocab-word:hover {
            color: inherit;
            background: linear-gradient(180deg, transparent 30%, rgba(96, 165, 250, 0.25) 30%, rgba(96, 165, 250, 0.25) 80%, transparent 80%);
        }
        
        /* PDFËØçÊ±áÊµÆÁ™ó - ‰∏éÊñáÊú¨ÈòÖËØª„ÄÅÂ≠óÂπïÊµÆÁ™óÊ†∑Âºè‰∏ÄËá¥ */
        .pdf-vocab-bubble {
            position: fixed;
            background: linear-gradient(135deg, #1e3a5f 0%, #1a2332 100%);
            border: 1px solid rgba(56, 189, 248, 0.4);
            border-radius: 8px;
            padding: 12px 14px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), 0 0 20px rgba(56, 189, 248, 0.2);
            z-index: 9999;
            max-width: 280px;
            min-width: 150px;
            animation: bubbleIn 180ms cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: auto;
        }
        
        .pdf-vocab-bubble .bubble-word {
            font-weight: 700;
            color: #38bdf8;
            font-size: 16px;
            margin-bottom: 6px;
            border-bottom: 1px solid rgba(56, 189, 248, 0.3);
            padding-bottom: 6px;
        }
        
        .pdf-vocab-bubble .bubble-meaning {
            color: #cbd5e1;
            font-size: 12px;
            margin-bottom: 4px;
            line-height: 1.4;
        }
        
        .pdf-vocab-bubble .bubble-note {
            color: #a7f3d0;
            font-size: 13px;
            line-height: 1.4;
            padding: 6px;
            background: rgba(34, 211, 153, 0.08);
            border-left: 2px solid rgba(34, 211, 153, 0.4);
            border-radius: 2px;
            margin: 0;
        }
    </style>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div id="toolbar">
        <span id="current-page-display">È°µ 1</span>
        <span>/</span>
        <span id="total-pages">0</span>
        <div class="sep"></div>
        <button id="zoom-out">‚àí</button>
        <input id="scale" type="text" value="auto" placeholder="auto">
        <span id="scale-label">(Ëá™ÈÄÇÂ∫î)</span>
        <button id="zoom-in">+</button>
        <div class="sep"></div>
        <button id="fit-width">ÈÄÇÂ∫îÂÆΩÂ∫¶</button>
        <button id="fit-page">ÈÄÇÂ∫îÈ°µÈù¢</button>
    </div>
    <div id="container">
        <div id="pages-container"></div>
    </div>
    <div id="loading"><div class="spinner"></div>Âä†ËΩΩ PDF ‰∏≠...</div>
    <div class="error" id="error"></div>
    <script src="/static/lib/pdf.min.js"></script>
    <script>
        console.log('üîç PDF Viewer loaded - Version 3.0 (Continuous Scroll)');
        pdfjsLib.GlobalWorkerOptions.workerSrc = '/static/lib/pdf.worker.min.js';
        
        const params = new URLSearchParams(window.location.search);
        let pdfUrl = params.get('file');
        const paramVocabBookId = params.get('vocabBookId') || null;
        if (pdfUrl && !pdfUrl.startsWith('http')) {
            pdfUrl = new URL(pdfUrl, window.location.origin).href;
        }
        
        if (!pdfUrl) { 
            document.getElementById('error').textContent = 'ÈîôËØØÔºöÊú™ÊåáÂÆö PDF Êñá‰ª∂'; 
            document.getElementById('error').style.display = 'block'; 
            throw new Error('No file'); 
        }
        
        let pdf = null, numPages = 0, currentScale = 'auto';
        const container = document.getElementById('container');
        const pagesContainer = document.getElementById('pages-container');
        
        // ============================================================================
        // PDFÁºìÂ≠òÁÆ°ÁêÜ - ‰øùÂ≠òÂíåÊÅ¢Â§çÁî®Êà∑ÁöÑÈòÖËØªËøõÂ∫¶
        // ============================================================================
        let pdfCacheData = null;  // ÂΩìÂâçÁºìÂ≠òÊï∞ÊçÆ
        let cacheAutoSaveTimeout = null;  // Èò≤ÊäñËÆ°Êó∂Âô®
        
        /**
         * ÁîüÊàêPDFÁºìÂ≠òÁöÑÂîØ‰∏ÄÈîÆÂêçÔºàÂü∫‰∫éÊñá‰ª∂URLÔºâ
         */
        function getPdfCacheName() {
            // ‰ªéURL‰∏≠ÊèêÂèñÊñá‰ª∂Âêç
            const urlObj = new URL(pdfUrl);
            const pathname = urlObj.pathname;
            const filename = pathname.substring(pathname.lastIndexOf('/') + 1) || 'unknown.pdf';
            return filename;
        }
        
        /**
         * ‰øùÂ≠òPDFÁºìÂ≠òÂà∞ÊúçÂä°Âô®
         */
        async function savePdfCache() {
            try {
                const cacheData = {
                    pdfFilename: getPdfCacheName(),
                    currentPage: parseInt(document.getElementById('current-page-display').textContent.match(/\\d+/)?.[0] || 1),
                    scale: currentScale,
                    scrollTop: container.scrollTop,
                    displayMode: 'continuous'
                };
                
                const response = await fetch('/api/pdf-cache/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(cacheData)
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    console.log('üíæ PDFÁºìÂ≠òÂ∑≤‰øùÂ≠ò:', getPdfCacheName());
                } else {
                    console.warn('‚ö†Ô∏è PDFÁºìÂ≠ò‰øùÂ≠òÂ§±Ë¥•:', result.error);
                }
            } catch (e) {
                console.error('‚ùå ‰øùÂ≠òPDFÁºìÂ≠òÊó∂Âá∫Èîô:', e);
            }
        }
        
        /**
         * Âä†ËΩΩPDFÁºìÂ≠òÔºàÈò≤Ê≠¢ÈáçÂ§çÊ∏≤ÊüìÔºâ
         */
        async function loadPdfCache() {
            try {
                const response = await fetch('/api/pdf-cache/load', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pdfFilename: getPdfCacheName() })
                });
                
                const result = await response.json();
                if (result.status === 'success' && result.found && result.cache) {
                    pdfCacheData = result.cache;
                    console.log('‚úÖ Âä†ËΩΩPDFÁºìÂ≠ò:', pdfCacheData);
                    return result.cache;
                } else {
                    console.log('‚ÑπÔ∏è Ê≤°ÊúâÊâæÂà∞PDFÁºìÂ≠òÔºåÂ∞Ü‰ªéÁ¨¨1È°µÂºÄÂßã');
                    return null;
                }
            } catch (e) {
                console.error('‚ùå Âä†ËΩΩPDFÁºìÂ≠òÊó∂Âá∫Èîô:', e);
                return null;
            }
        }
        
        /**
         * Â∫îÁî®ÁºìÂ≠òÁöÑÁî®Êà∑Áä∂ÊÄÅÔºàÁº©Êîæ„ÄÅÊªöÂä®‰ΩçÁΩÆÁ≠âÔºâ
         */
        async function applyCacheState(cache) {
            if (!cache) return;
            
            try {
                // Â∫îÁî®Áº©ÊîæÁ∫ßÂà´Ôºà‰ΩÜ‰∏çÈáçÊñ∞Ê∏≤ÊüìÔºåÊ∏≤Êüì‰ºöÂú®Ë∞ÉÁî®ËÄÖ‰∏≠ÂÆåÊàêÔºâ
                if (cache.scale) {
                    currentScale = cache.scale;
                    if (cache.scale === 'auto' || cache.scale === 'fit-width') {
                        document.getElementById('scale').value = 'auto';
                        document.getElementById('scale-label').textContent = '(ÈÄÇÂ∫îÂÆΩÂ∫¶)';
                    } else if (cache.scale === 'fit-page') {
                        document.getElementById('scale').value = 'auto';
                        document.getElementById('scale-label').textContent = '(ÈÄÇÂ∫îÈ°µÈù¢)';
                    } else {
                        const scalePercent = typeof cache.scale === 'number' ? Math.round(cache.scale * 100) : parseInt(cache.scale);
                        document.getElementById('scale').value = scalePercent;
                        document.getElementById('scale-label').textContent = '%';
                    }
                    // ‰∏çË¶ÅÂú®ËøôÈáåÈáçÊñ∞Ê∏≤ÊüìÔºåÊ∏≤Êüì‰ºöÂú®Ë∞ÉÁî®ËÄÖ‰∏≠ÂÆåÊàê
                    console.log('üìê Â∫îÁî®Áº©ÊîæÁ∫ßÂà´:', cache.scale);
                }
            } catch (e) {
                console.error('‚ùå Â∫îÁî®ÁºìÂ≠òÁä∂ÊÄÅÊó∂Âá∫Èîô:', e);
            }
        }
        
        /**
         * Èò≤Êäñ‰øùÂ≠òÁºìÂ≠òÔºàÊªöÂä®Êó∂Ôºâ
         */
        function debouncedSavePdfCache() {
            // Ê∏ÖÈô§‰πãÂâçÁöÑËÆ°Êó∂Âô®
            if (cacheAutoSaveTimeout) {
                clearTimeout(cacheAutoSaveTimeout);
            }
            
            // ËÆæÁΩÆÊñ∞ÁöÑËÆ°Êó∂Âô®Ôºà1ÁßíÂêé‰øùÂ≠òÔºâ
            cacheAutoSaveTimeout = setTimeout(() => {
                savePdfCache();
            }, 1000);
        }
        
        /**
         * È°µÈù¢Âç∏ËΩΩÊó∂‰øùÂ≠òÁºìÂ≠ò
         */
        window.addEventListener('beforeunload', () => {
            // Á´ãÂç≥‰øùÂ≠òÔºå‰∏çÁî®Èò≤Êäñ
            savePdfCache();
        });
        
        // Ëé∑ÂèñÁîüËØçÊú¨Êï∞ÊçÆÔºà‰ºòÂÖà‰ΩøÁî®Â§öÁîüËØçÊú¨Êñ∞Ê†ºÂºèÔºâ
        let vocabData = [];
        let vocabBooks = [];
        let currentVocabBookId = null;
        let settings = {};

        async function loadSettings() {
            try {
                const res = await fetch('/api/settings/load');
                const data = await res.json();
                if (data && data.status === 'success') {
                    settings = data.settings || {};
                }
            } catch (e) {
                console.warn('‚ö†Ô∏è Âä†ËΩΩËÆæÁΩÆÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§', e);
                settings = {};
            }
        }

        function pickCurrentBookId(books, currentId, settings) {
            if (currentId && books.find(b => b.id === currentId)) return currentId;
            if (!books || books.length === 0) return null;
            const common = settings.commonDefaultVocab;
            if (common) {
                const cv = books.find(b => b.name === 'ÈªòËÆ§ÁîüËØçÊú¨ÔºàÈÄöÁî®Ôºâ');
                if (cv) return cv.id;
            } else {
                const rv = books.find(b => b.name === 'ÈªòËÆ§ÁîüËØçÊú¨ÔºàÈòÖËØªÔºâ') || books.find(b => b.name === 'ÈªòËÆ§ÁîüËØçÊú¨(ÈòÖËØª)');
                if (rv) return rv.id;
            }
            return books[0].id;
        }

        async function loadVocabData() {
            console.log('üìö ÂºÄÂßãÂä†ËΩΩÁîüËØçÊú¨...');
            try {
                await loadSettings();
                // ÂÖàÂ∞ùËØïÊñ∞Ê†ºÂºè
                const response = await fetch('/api/vocabbooks/load');
                const data = await response.json();
                console.log('üì• ÁîüËØçÊú¨APIÂìçÂ∫î:', data);
                
                if (data && data.status === 'success' && Array.isArray(data.vocabBooks)) {
                    vocabBooks = data.vocabBooks;
                    console.log('üìñ ÁîüËØçÊú¨Êï∞Èáè:', vocabBooks.length);
                    
                    // Â¶ÇÊûúÁà∂È°µÈù¢‰º†ÂÖ•‰∫ÜÂΩìÂâçÁîüËØçÊú¨IDÔºåÂàô‰ºòÂÖà‰ΩøÁî®ÂÆÉ
                    if (paramVocabBookId && vocabBooks.find(b => b.id === paramVocabBookId)) {
                        currentVocabBookId = paramVocabBookId;
                        console.log('‚úì ‰ΩøÁî®‰º†ÂÖ•ÁöÑÁîüËØçÊú¨ID:', paramVocabBookId);
                    } else {
                        currentVocabBookId = pickCurrentBookId(vocabBooks, data.currentVocabBookId, settings);
                        console.log('‚úì ÈÄâÊã©ÈªòËÆ§ÁîüËØçÊú¨:', currentVocabBookId);
                    }
                    
                    const currentBook = vocabBooks.find(b => b.id === currentVocabBookId);
                    vocabData = currentBook ? (currentBook.words || []) : [];
                    console.log('‚úÖ ÁîüËØçÊú¨Âä†ËΩΩÊàêÂäü: Êú¨Âêç=', currentBook ? currentBook.name : 'Êú™ÈÄâÊã©', ', ËØçÊï∞=', vocabData.length);
                    
                    // ÊâìÂç∞ÂâçÂá†‰∏™ËØçÊ±áÁî®‰∫éË∞ÉËØï
                    if (vocabData.length > 0) {
                        console.log('üìã ËØçÊ±áÁ§∫‰æã:', vocabData.slice(0, 3).map(w => w.word).join(', '));
                    }
                    return;
                }
            } catch (e) {
                console.error('‚ùå Â§öÁîüËØçÊú¨Âä†ËΩΩÂ§±Ë¥•:', e);
            }
            
            // ÊóßÊ†ºÂºèÈôçÁ∫ß
            try {
                console.log('üîÑ Â∞ùËØïÊóßÊ†ºÂºèÁîüËØçÊú¨...');
                const res2 = await fetch('/api/vocab/load');
                const data2 = await res2.json();
                vocabData = data2.vocab || [];
                console.log('‚úÖ ÁîüËØçÊú¨(ÊóßÊ†ºÂºè)Âä†ËΩΩÊàêÂäüÔºåÂÖ±', vocabData.length, '‰∏™ËØç');
            } catch (e2) {
                console.error('‚ùå ÁîüËØçÊú¨Âä†ËΩΩÂÆåÂÖ®Â§±Ë¥•:', e2);
                vocabData = [];
            }
        }
        
        // ‰øùÂ≠òÁîüËØçÂà∞ÁîüËØçÊú¨
        async function saveToVocab(word, meaning, note) {
            try {
                // ‰ºòÂÖà‰øùÂ≠òÂà∞Â§öÁîüËØçÊú¨
                if (Array.isArray(vocabBooks) && currentVocabBookId) {
                    const currentBookIdx = vocabBooks.findIndex(b => b.id === currentVocabBookId);
                    if (currentBookIdx >= 0) {
                        const words = vocabBooks[currentBookIdx].words || [];
                        const idx = words.findIndex(v => v.word && v.word.toLowerCase() === word.toLowerCase());
                        if (idx >= 0) {
                            words[idx].meaning = meaning;
                            words[idx].note = note;
                        } else {
                            words.push({ id: Date.now().toString(), word, meaning, note, source: 'reading' });
                        }
                        vocabBooks[currentBookIdx].words = words;
                        vocabData = words;

                        const resp = await fetch('/api/vocabbooks/save', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ vocabBooks, currentVocabBookId })
                        });
                        const result = await resp.json();
                        const ok = result && result.status === 'success';
                        if (ok) {
                            // ÈÄöÁü•Áà∂È°µÈù¢ÔºàÂ¶ÇÊûúÂú®iframe‰∏≠ÔºâÂà∑Êñ∞ÁîüËØçÊú¨ÊòæÁ§∫
                            try { window.parent.postMessage({ type: 'vocabBooksUpdated' }, '*'); } catch {}
                            console.log('‚úÖ ‰øùÂ≠òÊàêÂäü:', word);
                            refreshAllTextLayerHighlights();
                            return true;
                        } else {
                            console.warn('‚ö†Ô∏è ‰øùÂ≠òËøîÂõûÈùûÊàêÂäü(Êñ∞Ê†ºÂºè):', result);
                        }
                    }
                }

                // Â§áÁî®ÔºöÊóßÊ†ºÂºè‰øùÂ≠ò
                const existingIndex = vocabData.findIndex(v => v.word.toLowerCase() === word.toLowerCase());
                if (existingIndex >= 0) {
                    vocabData[existingIndex] = { word, meaning, note };
                } else {
                    vocabData.push({ word, meaning, note });
                }
                const response = await fetch('/api/vocab/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vocab: vocabData })
                });
                const result = await response.json();
                const ok2 = (result && (result.status === 'success' || result.success === true));
                if (ok2) {
                    console.log('‚úÖ ‰øùÂ≠òÊàêÂäü(ÊóßÊ†ºÂºè):', word);
                    refreshAllTextLayerHighlights();
                    return true;
                }
            } catch (e) {
                console.error('‚ùå ‰øùÂ≠òÂ§±Ë¥•:', e);
            }
            return false;
        }
        
        // ÂàõÂª∫Ê∞îÊ≥°ÁºñËæëÊ®°Âºè
        function showBubbleEditMode(bubble, word, vocabItem) {
            const meaning = vocabItem ? vocabItem.meaning || '' : '';
            const note = vocabItem ? vocabItem.note || '' : '';
            
            bubble.innerHTML = `
                <div class="bubble-word">${word}</div>
                <div class="bubble-edit-form">
                    <div class="bubble-form-group">
                        <label>Èáä‰πâ</label>
                        <input type="text" class="bubble-input edit-meaning" placeholder="ËæìÂÖ•Èáä‰πâ..." value="${meaning}">
                    </div>
                    <div class="bubble-form-group">
                        <label>ÊâπÊ≥®</label>
                        <textarea class="bubble-textarea edit-note" placeholder="ËæìÂÖ•ÊâπÊ≥®ÔºàShift+ÂõûËΩ¶Êç¢Ë°åÔºâ...">${note}</textarea>
                    </div>
                    <div class="bubble-buttons">
                        <button class="bubble-cancel-btn">‚úñ ÂèñÊ∂à</button>
                        <button class="bubble-save-btn">üíæ ‰øùÂ≠ò</button>
                    </div>
                </div>
            `;
            
            const saveBtn = bubble.querySelector('.bubble-save-btn');
            const cancelBtn = bubble.querySelector('.bubble-cancel-btn');
            const meaningInput = bubble.querySelector('.edit-meaning');
            const noteInput = bubble.querySelector('.edit-note');
            
            // ÊâßË°å‰øùÂ≠ò
            const performSave = async () => {
                const newMeaning = meaningInput.value.trim();
                const newNote = noteInput.value.trim();
                
                const success = await saveToVocab(word, newMeaning, newNote);
                if (success) {
                    bubble.remove();
                    window.getSelection().removeAllRanges();
                }
            };
            
            // ‰øùÂ≠òÊåâÈíÆÁÇπÂáª
            saveBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                performSave();
            }, true);
            
            // ÂèñÊ∂àÊåâÈíÆÁÇπÂáª
            cancelBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                bubble.remove();
                window.getSelection().removeAllRanges();
            }, true);
            
            // Ëá™Âä®ËÅöÁÑ¶Âà∞Èáä‰πâËæìÂÖ•Ê°Ü
            setTimeout(() => {
                meaningInput.focus();
                
                // Èáä‰πâËæìÂÖ•Ê°ÜÔºöÂõûËΩ¶‰øùÂ≠ò
                meaningInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        performSave();
                    }
                });
                
                // ÊâπÊ≥®ÊñáÊú¨Ê°ÜÔºöShift+ÂõûËΩ¶Êç¢Ë°åÔºåÂõûËΩ¶‰øùÂ≠ò
                noteInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        if (e.shiftKey) {
                            // Shift+ÂõûËΩ¶ÔºöÊç¢Ë°åÔºå‰∏ç‰øùÂ≠ò
                            return;
                        } else {
                            // ÂõûËΩ¶Ôºö‰øùÂ≠ò
                            e.preventDefault();
                            performSave();
                        }
                    }
                });
            }, 0);
        }
        
        // ============================================================================
        // PDFËØçÊ±áÈ´ò‰∫ÆÂíåÊµÆÁ™ó - ‰∏éÊñáÊú¨ÈòÖËØªÂíåÂ≠óÂπï‰∏ÄËá¥ÁöÑ‰ΩìÈ™å
        // ============================================================================

        // ÈáçÊñ∞ÂØπÂ∑≤Ê∏≤ÊüìÈ°µÈù¢ÁöÑÊñáÊú¨Â±ÇÊâßË°åÈ´ò‰∫ÆÔºàÁî®‰∫éÊñ∞Â¢ûÊàñ‰øÆÊîπËØçÊ±áÂêéÁ´ãÂç≥ÁîüÊïàÔºâ
        function refreshAllTextLayerHighlights() {
            const layers = document.querySelectorAll('.textLayer');
            layers.forEach(layer => {
                try {
                    highlightVocabInPdfTextLayer(layer);
                } catch (e) {
                    console.warn('‚ö†Ô∏è Âà∑Êñ∞È´ò‰∫ÆÂ§±Ë¥•:', e);
                }
            });
        }
        
        /**
         * Âú®PDFÊñáÊú¨Â±Ç‰∏≠È´ò‰∫ÆÁîüËØçÊú¨ËØçÊ±á
         * ‰∏éÊñáÊú¨ÈòÖËØªÊ®°Âùó‰∏≠ÁöÑ highlightReadingVocabInContent() ÂäüËÉΩ‰∏ÄËá¥
         */
        function highlightVocabInPdfTextLayer(textLayer) {
            console.log('üîç [È´ò‰∫ÆÂºÄÂßã] ÁîüËØçÊï∞ÊçÆ:', vocabData ? vocabData.length : 0);
            
            if (!vocabData || !vocabData.length) {
                console.warn('‚ö†Ô∏è ÁîüËØçÊú¨‰∏∫Á©∫ÔºåË∑≥ËøáÈ´ò‰∫Æ');
                return;
            }
            
            // ÁîüÊàêËØçÊ±áÂàóË°®
            const vocabItems = vocabData
                .filter(w => w.word && w.word.trim())
                .map(w => ({
                    word: w.word,
                    wordLower: w.word.toLowerCase(),
                    meaning: w.meaning || '',
                    note: w.note || '',
                    hasNote: !!(w.note)
                }));
            
            console.log('üìö ÊúâÊïàËØçÊ±áÊï∞:', vocabItems.length);
            
            if (!vocabItems.length) return;
            
            // Ëé∑ÂèñÊâÄÊúâÊñáÊú¨ËäÇÁÇπÂÆπÂô®ÔºàÊñ∞ÁâàPDF.jsÂèØËÉΩÁî®divËÄåÈùûspanÔºâ
            const allSpans = textLayer.querySelectorAll('span, div');
            console.log('üìÑ ÊÄªspanÊï∞:', allSpans.length);
            
            // ËøáÊª§Âá∫ÊúâÊñáÊú¨ÂÜÖÂÆπÁöÑspan/div
            const textSpans = Array.from(allSpans).filter(span => {
                const text = span.textContent || '';
                return text.trim().length > 0;
            });
            
            console.log('üìù ÊúâÂÜÖÂÆπÁöÑspanÊï∞:', textSpans.length);
            
            if (!textSpans.length) {
                console.warn('‚ö†Ô∏è Ê≤°ÊúâÊâæÂà∞ÊñáÊú¨ÂÜÖÂÆπÁöÑspan');
                return;
            }
            
            let totalHighlights = 0;
            let processedSpans = 0;
            
            // Â§ÑÁêÜÊØè‰∏™ÊñáÊú¨span
            textSpans.forEach((span, spanIdx) => {
                processedSpans++;
                const text = span.textContent;
                const matches = [];
                
                // ÂâçÂá†‰∏™spanËæìÂá∫ËØ¶ÁªÜ‰ø°ÊÅØÁî®‰∫éË∞ÉËØï
                if (spanIdx < 3) {
                    console.log(`üìù [span${spanIdx}] ÂéüÊñáÊú¨: "${text.substring(0, 80)}${text.length > 80 ? '...' : ''}"`);
                    console.log(`   ÊñáÊú¨ÈïøÂ∫¶: ${text.length}ÔºåËØçÊ±áÈïøÂ∫¶ËåÉÂõ¥: 1-${Math.max(...vocabItems.map(v => v.word.length))}`);
                }
                
                // Êü•ÊâæÂåπÈÖçÁöÑËØçÊ±á
                vocabItems.forEach(item => {
                    const wordLower = item.word.toLowerCase();
                    const textLower = text.toLowerCase();
                    
                    let searchIdx = 0;
                    let foundCount = 0;
                    
                    while (true) {
                        const foundIdx = textLower.indexOf(wordLower, searchIdx);
                        if (foundIdx === -1) break;
                        
                        foundCount++;
                        
                        // ÊîπËøõÁöÑËæπÁïåÊ£ÄÊü•
                        const before = foundIdx > 0 ? text[foundIdx - 1] : '';
                        const after = foundIdx + item.word.length < text.length 
                            ? text[foundIdx + item.word.length] 
                            : '';
                        
                        // Ê£ÄÊü•ÊòØÂê¶ÊòØÂçïËØçËæπÁïå
                        const isWordBefore = /[a-zA-Z0-9–∞-—è–ê-–Ø—ë–Å]/.test(before);
                        const isWordAfter = /[a-zA-Z0-9–∞-—è–ê-–Ø—ë–Å]/.test(after);
                        
                        // Êñ∞ËßÑÂàôÔºöÂè™Ë¶ÅÂâçÊàñÂêé‰∏çÊòØÂ≠óÊØçÔºåÂ∞±ËÆ§‰∏∫ÊòØËØçÊ±áËæπÁïå
                        if (!isWordBefore || !isWordAfter) {
                            matches.push({
                                index: foundIdx,
                                len: item.word.length,
                                item,
                                text: text.substr(foundIdx, item.word.length)
                            });
                            
                            if (spanIdx < 2) {
                                console.log(`  ‚úì [span${spanIdx}] ÂåπÈÖç "${item.word}" @ ‰ΩçÁΩÆ${foundIdx}, ‰∏ä‰∏ãÊñá: "...${text.substring(Math.max(0, foundIdx-10), Math.min(text.length, foundIdx+item.word.length+10))}..."`);
                            }
                        }
                        searchIdx = foundIdx + 1;
                    }
                    
                    // Â¶ÇÊûúÂú®ÂâçÂá†‰∏™span‰∏≠ÊâæÂà∞ËØçÊ±áÔºåËæìÂá∫ÊèêÁ§∫
                    if (spanIdx < 2 && foundCount > 0) {
                        console.log(`  üìå "${item.word}" Âú®ÊñáÊú¨‰∏≠Âá∫Áé∞ ${foundCount} Ê¨°ÔºåÊúâÊïàÂåπÈÖç: ${matches.filter(m => m.item.word === item.word).length} Ê¨°`);
                    }
                });
                
                if (!matches.length) return;
                
                // ÂéªÈáçÂπ∂ÊéíÂ∫è
                matches.sort((a, b) => a.index - b.index);
                const uniqueMatches = [];
                let lastIdx = -1;
                matches.forEach(m => {
                    if (m.index !== lastIdx) {
                        uniqueMatches.push(m);
                        lastIdx = m.index;
                    }
                });
                
                // ÈáçÂª∫DOM
                const frag = document.createDocumentFragment();
                let cursor = 0;
                
                uniqueMatches.forEach(m => {
                    if (m.index > cursor) {
                        frag.appendChild(document.createTextNode(text.slice(cursor, m.index)));
                    }
                    
                    const hSpan = document.createElement('span');
                    hSpan.className = m.item.hasNote ? 'pdf-vocab-highlight' : 'pdf-vocab-word';
                    hSpan.textContent = m.text;
                    hSpan.dataset.word = m.item.wordLower;
                    hSpan.dataset.meaning = m.item.meaning;
                    hSpan.dataset.note = m.item.note;
                    
                    // Ê∑ªÂä†Âº∫Âà∂ÂÜÖËÅîÊ†∑ÂºèÔºåÁ°Æ‰øùÊòæÁ§∫
                    if (m.item.hasNote) {
                        hSpan.style.cssText = `
                            background: #ffeb3b !important;
                            color: #000 !important;
                            padding: 0 !important;
                            margin: 0 !important;
                            border-radius: 1px !important;
                            cursor: pointer !important;
                            display: inline !important;
                            box-shadow: none !important;
                            line-height: inherit !important;
                            text-decoration-line: underline !important;
                            text-decoration-style: wavy !important;
                            text-decoration-color: #f59e0b !important;
                            text-decoration-thickness: 1px !important;
                            text-underline-offset: 1px !important;
                            text-decoration-skip-ink: none !important;
                            text-decoration-skip: none !important;
                        `;
                    }
                    
                    hSpan.addEventListener('mouseenter', (e) => {
                        console.log('üéØ ÊÇ¨ÂÅúËØç:', m.item.word);
                        showPdfVocabBubble(hSpan, m.item);
                    });
                    hSpan.addEventListener('mouseleave', () => hidePdfVocabBubble());
                    
                    frag.appendChild(hSpan);
                    totalHighlights++;
                    cursor = m.index + m.len;
                });
                
                if (cursor < text.length) {
                    frag.appendChild(document.createTextNode(text.slice(cursor)));
                }
                
                // ÊõøÊç¢ÂéüspanÂÜÖÂÆπ
                while (span.firstChild) {
                    span.removeChild(span.firstChild);
                }
                span.appendChild(frag);
                
                // Ë∞ÉËØïÔºöÊ£ÄÊü•spanÊòØÂê¶ÁúüÁöÑË¢´Ê∑ªÂä†‰∫Ü
                if (spanIdx < 2 && uniqueMatches.length > 0) {
                    const highlightSpans = span.querySelectorAll('.pdf-vocab-highlight');
                    if (highlightSpans.length > 0) {
                        const color = window.getComputedStyle(highlightSpans[0])?.backgroundColor || 'unknown';
                        console.log(`  ‚úì [span${spanIdx}] Ê∑ªÂä†${highlightSpans.length}‰∏™È´ò‰∫ÆspanÂà∞DOMÔºåÈ¢úËâ≤: ${color}`);
                    }
                }
            });
            
            console.log(`‚úÖ È´ò‰∫ÆÂÆåÊàê: Â§ÑÁêÜ${processedSpans}‰∏™span, ÂÖ±ÊâæÂà∞${totalHighlights}Â§ÑÈ´ò‰∫Æ`);
        }
        
        /**
         * ÊòæÁ§∫PDFËØçÊ±áÊµÆÁ™óÔºàÈº†Ê†áÊÇ¨ÂÅúÊó∂Ôºâ
         * Ê†∑ÂºèÂíåÂäüËÉΩ‰∏éÊñáÊú¨ÈòÖËØª„ÄÅÂ≠óÂπïÁöÑÊµÆÁ™ó‰∏ÄËá¥
         */
        function showPdfVocabBubble(element, vocabItem) {
            // ÁßªÈô§Â∑≤Â≠òÂú®ÁöÑÊ∞îÊ≥°
            document.querySelectorAll('.pdf-vocab-bubble').forEach(b => b.remove());
            
            // ÂàõÂª∫Ê∞îÊ≥°ÂÆπÂô®
            const bubble = document.createElement('div');
            bubble.className = 'pdf-vocab-bubble';
            
            // ÊûÑÂª∫Ê∞îÊ≥°ÂÜÖÂÆπ
            let bubbleHTML = `<div class="bubble-word">${vocabItem.word}</div>`;
            if (vocabItem.meaning) {
                bubbleHTML += `<div class="bubble-meaning">${vocabItem.meaning}</div>`;
            }
            if (vocabItem.note) {
                bubbleHTML += `<div class="bubble-note"><strong>ÊâπÊ≥®Ôºö</strong>${vocabItem.note}</div>`;
            }
            
            bubble.innerHTML = bubbleHTML;
            document.body.appendChild(bubble);
            
            // ÂÆö‰ΩçÊ∞îÊ≥°
            const rect = element.getBoundingClientRect();
            let left = rect.left + window.scrollX + rect.width / 2 - bubble.offsetWidth / 2;
            let top = rect.top + window.scrollY - bubble.offsetHeight - 8;
            
            // ËæπÁïåÊ£ÄÊü•
            const minLeft = 10;
            const maxLeft = window.innerWidth - bubble.offsetWidth - 10;
            left = Math.max(minLeft, Math.min(left, maxLeft));
            
            if (top < 10) {
                top = rect.bottom + window.scrollY + 8;
            }
            
            bubble.style.left = left + 'px';
            bubble.style.top = top + 'px';
            
            // Ê∞îÊ≥°Èº†Ê†áÁ¶ªÂºÄÊó∂Â§ÑÁêÜ
            bubble.addEventListener('mouseleave', () => {
                setTimeout(() => {
                    if (!element.matches(':hover')) {
                        bubble.remove();
                    }
                }, 100);
            });
        }
        
        /**
         * ÈöêËóèPDFËØçÊ±áÊ∞îÊ≥°
         */
        function hidePdfVocabBubble() {
            setTimeout(() => {
                const bubble = document.querySelector('.pdf-vocab-bubble');
                if (bubble && !bubble.matches(':hover')) {
                    bubble.remove();
                }
            }, 100);
        }
        
        // ÊòæÁ§∫ÂàíËØçÊ∞îÊ≥°
        function showSelectionBubble() {
            setTimeout(() => {
                const selection = window.getSelection().toString().trim();
                if (!selection || selection.length === 0) return;
                
                // Ê£ÄÊü•ÈÄâÊã©ÊòØÂê¶Âú®PDFÂÆπÂô®ÂÜÖ
                try {
                    const range = window.getSelection().getRangeAt(0);
                    if (!pagesContainer.contains(range.commonAncestorContainer)) return;
                } catch (e) {
                    return;
                }
                
                // ÁßªÈô§Â∑≤Â≠òÂú®ÁöÑÊ∞îÊ≥°
                document.querySelectorAll('.vocab-bubble').forEach(b => b.remove());
                
                // Êü•ÊâæÁîüËØçÊú¨‰∏≠ÁöÑËØçÊ±á
                const vocabItem = vocabData.find(v => v.word.toLowerCase() === selection.toLowerCase());
                
                // ÂàõÂª∫Ê∞îÊ≥°
                const bubble = document.createElement('div');
                bubble.className = 'vocab-bubble';
                bubble.innerHTML = `
                    <div class="bubble-word">${selection}</div>
                    ${vocabItem ? `<div class="bubble-meaning">${vocabItem.meaning || 'Êú™ËÆæÁΩÆÈáä‰πâ'}</div>` : ''}
                    ${vocabItem && vocabItem.note ? `<div class="bubble-note">${vocabItem.note}</div>` : ''}
                    <div class="bubble-buttons">
                        <button class="bubble-note-btn">üìù Ê∑ªÂä†</button>
                    </div>
                `;
                
                // ÁºñËæëÊåâÈíÆ‰∫ã‰ª∂
                const noteBtn = bubble.querySelector('.bubble-note-btn');
                if (noteBtn) {
                    noteBtn.onclick = (e) => {
                        e.stopPropagation();
                        showBubbleEditMode(bubble, selection, vocabItem);
                    };
                }
                
                // ÂÆö‰ΩçÊ∞îÊ≥°
                try {
                    const rect = window.getSelection().getRangeAt(0).getBoundingClientRect();
                    document.body.appendChild(bubble);
                    
                    let left = rect.left + window.scrollX + rect.width / 2 - bubble.offsetWidth / 2;
                    let top = rect.top + window.scrollY - bubble.offsetHeight - 10;
                    
                    // ËæπÁïåÊ£ÄÊü•
                    const minLeft = 10;
                    const maxLeft = window.innerWidth - bubble.offsetWidth - 10;
                    left = Math.max(minLeft, Math.min(left, maxLeft));
                    
                    if (top < 10) {
                        top = rect.bottom + window.scrollY + 10;
                    }
                    
                    bubble.style.left = left + 'px';
                    bubble.style.top = top + 'px';
                } catch (e) {
                    console.error('‚ùå Ê∞îÊ≥°ÂÆö‰ΩçÂ§±Ë¥•:', e);
                    return;
                }
                
                // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠Ê∞îÊ≥°
                const closeHandler = (e) => {
                    if (e.target === bubble || bubble.contains(e.target)) return;
                    bubble.remove();
                    document.removeEventListener('click', closeHandler, true);
                };
                document.addEventListener('click', closeHandler, true);
                
            }, 50);
        }
        
        async function renderAllPages() {
            if (!pdf) return;
            
            pagesContainer.innerHTML = '';
            const containerWidth = container.clientWidth - 32;
            
            // ‰ΩøÁî®ËßÜÂè£ÂÜÖÊ∏≤ÊüìÁ≠ñÁï•ÔºöÂè™Ê∏≤ÊüìÂèØËßÅÂå∫ÂüüÈôÑËøëÁöÑÈ°µÈù¢
            // ÂØπ‰∫éÂ§ßÂûãPDFÔºåÂàùÂßãÂè™Ê∏≤ÊüìÁ¨¨1È°µÔºåÂÖ∂‰ªñÈ°µÈù¢ÊåâÈúÄÂä†ËΩΩ
            const initialPages = Math.min(2, numPages); // ÂáèÂ∞ëÂàùÂßãÊ∏≤ÊüìÈ°µÊï∞
            console.log(`üìñ Á´ãÂç≥Ê∏≤ÊüìÂâç${initialPages}È°µÔºåÂÖ±${numPages}È°µÔºàÂ§ßÂûãPDF‰ºòÂåñÊ®°ÂºèÔºâ`);
            
            for (let pageNum = 1; pageNum <= initialPages; pageNum++) {
                await renderSinglePage(pageNum, containerWidth);
            }
            
            // ‰ΩøÁî®Intersection ObserverÂÆûÁé∞ÊáíÂä†ËΩΩ
            setupLazyLoading();
            
            updateCurrentPage();
        }
        
        /**
         * ËÆæÁΩÆIntersection ObserverÂÆûÁé∞È°µÈù¢ÊáíÂä†ËΩΩ
         */
        function setupLazyLoading() {
            // Ê∏ÖÁêÜ‰πãÂâçÁöÑobserver
            if (window.pdfIntersectionObserver) {
                window.pdfIntersectionObserver.disconnect();
            }
            
            // ÂàõÂª∫Êñ∞ÁöÑIntersection Observer
            window.pdfIntersectionObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const pageWrapper = entry.target;
                        const pageNum = parseInt(pageWrapper.dataset.pageNumber);
                        
                        // Â¶ÇÊûúÈ°µÈù¢ËøòÊ≤°ÊúâÊ∏≤ÊüìÂÜÖÂÆπ
                        if (!pageWrapper.querySelector('.page-canvas')) {
                            console.log(`üëÄ È°µÈù¢${pageNum}ËøõÂÖ•ËßÜÂè£ÔºåÂºÄÂßãÊ∏≤Êüì`);
                            renderSinglePage(pageNum, container.clientWidth - 32, pageWrapper);
                        }
                        
                        // ÂÅúÊ≠¢ËßÇÂØüÂ∑≤Ê∏≤ÊüìÁöÑÈ°µÈù¢
                        window.pdfIntersectionObserver.unobserve(pageWrapper);
                    }
                });
            }, {
                root: container,
                rootMargin: '200px', // ÊèêÂâç200pxÂºÄÂßãÂä†ËΩΩ
                threshold: 0.1
            });
            
            // ‰∏∫ÊâÄÊúâÈ°µÈù¢ÂàõÂª∫Âç†‰ΩçÁ¨¶Âπ∂ÂºÄÂßãËßÇÂØü
            for (let pageNum = 1; pageNum <= numPages; pageNum++) {
                // Ê£ÄÊü•ÊòØÂê¶Â∑≤Ê∏≤Êüì
                if (document.querySelector(`[data-page-number="${pageNum}"]`)) {
                    continue;
                }
                
                // ÂàõÂª∫Âç†‰ΩçÁ¨¶
                const placeholder = createPagePlaceholder(pageNum);
                pagesContainer.appendChild(placeholder);
                
                // ÂºÄÂßãËßÇÂØü
                window.pdfIntersectionObserver.observe(placeholder);
            }
        }
        
        /**
         * ÂàõÂª∫È°µÈù¢Âç†‰ΩçÁ¨¶ÔºàÁî®‰∫éÊáíÂä†ËΩΩÔºâ
         */
        function createPagePlaceholder(pageNum) {
            const placeholder = document.createElement('div');
            placeholder.className = 'page-placeholder';
            placeholder.dataset.pageNumber = pageNum;
            placeholder.style.width = '100%';
            placeholder.style.height = '800px'; // È¢Ñ‰º∞È´òÂ∫¶
            placeholder.style.background = 'rgba(30, 41, 59, 0.3)';
            placeholder.style.borderRadius = '4px';
            placeholder.style.display = 'flex';
            placeholder.style.alignItems = 'center';
            placeholder.style.justifyContent = 'center';
            placeholder.style.color = '#94a3b8';
            placeholder.innerHTML = `<div>Á¨¨ ${pageNum} È°µ - Âä†ËΩΩ‰∏≠...</div>`;
            
            return placeholder;
        }
        
        /**
         * Ê∏≤ÊüìÂçï‰∏™È°µÈù¢ÔºàÊîØÊåÅ‰º†ÂÖ•Áé∞ÊúâÁöÑÂç†‰ΩçÁ¨¶ÂÆπÂô®Ôºâ
         */
        async function renderSinglePage(pageNum, containerWidth, existingContainer = null) {
            try {
                const page = await pdf.getPage(pageNum);
                const baseViewport = page.getViewport({ scale: 1 });
                
                let scale;
                if (currentScale === 'auto' || currentScale === 'fit-width') {
                    scale = containerWidth / baseViewport.width;
                } else if (currentScale === 'fit-page') {
                    const containerHeight = container.clientHeight - 64;
                    const scaleX = containerWidth / baseViewport.width;
                    const scaleY = containerHeight / baseViewport.height;
                    scale = Math.min(scaleX, scaleY);
                } else {
                    scale = parseFloat(currentScale);
                }
                
                const viewport = page.getViewport({ scale });
                
                // ‰ΩøÁî®Áé∞ÊúâÂÆπÂô®ÊàñÂàõÂª∫Êñ∞ÂÆπÂô®
                let pageWrapper;
                if (existingContainer) {
                    pageWrapper = existingContainer;
                    pageWrapper.className = 'page-wrapper';
                    pageWrapper.innerHTML = ''; // Ê∏ÖÁ©∫Âç†‰ΩçÁ¨¶ÂÜÖÂÆπ
                } else {
                    pageWrapper = document.createElement('div');
                    pageWrapper.className = 'page-wrapper';
                }
                
                pageWrapper.style.width = viewport.width + 'px';
                pageWrapper.style.height = viewport.height + 'px';
                pageWrapper.dataset.pageNumber = pageNum;
                
                // È°µÁ†ÅÊ†áÁ≠æ
                const pageLabel = document.createElement('div');
                pageLabel.className = 'page-number';
                pageLabel.textContent = `Á¨¨ ${pageNum} È°µ`;
                pageWrapper.appendChild(pageLabel);
                
                // CanvasÂ±Ç
                const canvas = document.createElement('canvas');
                canvas.className = 'page-canvas';
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                pageWrapper.appendChild(canvas);
                
                // ‰ΩøÁî®requestIdleCallbackÂú®Á©∫Èó≤Êó∂Èó¥Ê∏≤ÊüìÔºåÈÅøÂÖçÈòªÂ°ûUI
                if ('requestIdleCallback' in window) {
                    await new Promise((resolve) => {
                        requestIdleCallback(async () => {
                            const ctx = canvas.getContext('2d');
                            await page.render({ canvasContext: ctx, viewport }).promise;
                            resolve();
                        }, { timeout: 1000 });
                    });
                } else {
                    // ÈôçÁ∫ßÊñπÊ°àÔºöÁõ¥Êé•Ê∏≤Êüì
                    const ctx = canvas.getContext('2d');
                    await page.render({ canvasContext: ctx, viewport }).promise;
                }
                
                // TextLayer
                const textLayer = document.createElement('div');
                textLayer.className = 'textLayer';
                textLayer.style.width = viewport.width + 'px';
                textLayer.style.height = viewport.height + 'px';
                textLayer.style.setProperty('--scale-factor', scale);
                pageWrapper.appendChild(textLayer);
                
                const textContent = await page.getTextContent();
                
                // Ê∏≤ÊüìÊñáÊú¨Â±Ç
                const renderResult = pdfjsLib.renderTextLayer({
                    textContentSource: textContent,
                    container: textLayer,
                    viewport,
                    textDivs: []
                });
                
                // Á≠âÂæÖÊñáÊú¨Â±ÇÊ∏≤ÊüìÂÆåÊàê
                if (renderResult && renderResult.promise) {
                    await renderResult.promise;
                } else {
                    await new Promise(resolve => setTimeout(resolve, 30));
                }
                
                // ‰ºòÂåñÔºöÂè™Âú®È°µÈù¢ÂèØËßÅÊó∂ËøõË°åÈ´ò‰∫Æ
                if (isElementInViewport(pageWrapper)) {
                    highlightVocabInPdfTextLayer(textLayer);
                } else {
                    // Ê†áËÆ∞ÈúÄË¶ÅÈ´ò‰∫ÆÔºåÁ®çÂêéÂ§ÑÁêÜ
                    textLayer.dataset.needsHighlight = 'true';
                }
                
                // ‰∏∫TextLayerÊ∑ªÂä†ÂàíËØç‰∫ã‰ª∂
                textLayer.addEventListener('mouseup', showSelectionBubble);
                
                // AnnotationLayerÔºàÈ¢ÑÁïôÔºâ
                const annotationLayer = document.createElement('div');
                annotationLayer.className = 'annotationLayer';
                pageWrapper.appendChild(annotationLayer);
                
                // Â¶ÇÊûú‰∏çÊòØÁé∞ÊúâÂÆπÂô®ÔºåÊ∑ªÂä†Âà∞È°µÈù¢
                if (!existingContainer) {
                    pagesContainer.appendChild(pageWrapper);
                }
                
                console.log(`‚úÖ Á¨¨${pageNum}È°µÊ∏≤ÊüìÂÆåÊàê`);
                
            } catch (e) {
                console.error(`‚ùå Á¨¨${pageNum}È°µÊ∏≤ÊüìÂ§±Ë¥•:`, e);
            }
        }
        
        /**
         * Ê£ÄÊü•ÂÖÉÁ¥†ÊòØÂê¶Âú®ËßÜÂè£ÂÜÖ
         */
        function isElementInViewport(el) {
            const rect = el.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();
            
            return (
                rect.top <= containerRect.bottom + 200 && // ÊèêÂâç200px
                rect.bottom >= containerRect.top - 200 &&
                rect.left <= containerRect.right &&
                rect.right >= containerRect.left
            );
        }
        
        /**
         * Ê£ÄÊü•Âπ∂Â§ÑÁêÜÈúÄË¶ÅÈ´ò‰∫ÆÁöÑÊñáÊú¨Â±Ç
         */
        function processPendingHighlights() {
            const textLayers = document.querySelectorAll('.textLayer[data-needs-highlight="true"]');
            textLayers.forEach(layer => {
                const pageWrapper = layer.closest('.page-wrapper');
                if (pageWrapper && isElementInViewport(pageWrapper)) {
                    highlightVocabInPdfTextLayer(layer);
                    layer.removeAttribute('data-needs-highlight');
                }
            });
        }
        
        /**
         * ÂêéÂè∞Âä†ËΩΩÂâ©‰ΩôÈ°µÈù¢Ôºà‰∏çÈòªÂ°û‰∏ªÁ∫øÁ®ãÔºâ
         */
        async function renderRemainingPages(startPage) {
            if (startPage > numPages) return;
            
            const containerWidth = container.clientWidth - 32;
            const batchSize = 2;  // ÊØèÊâπÊ¨°Âä†ËΩΩ2È°µÔºåÈôç‰ΩéCPUÂç†Áî®
            
            console.log(`üìö ÂêéÂè∞ÂºÄÂßãÂä†ËΩΩÔºåËµ∑ÂßãÈ°µ:${startPage}`);
            
            for (let pageNum = startPage; pageNum <= numPages; pageNum++) {
                try {
                    // Ê£ÄÊü•È°µÈù¢ÊòØÂê¶Â∑≤Â≠òÂú®
                    if (document.querySelector(`[data-page-number="${pageNum}"]`)) {
                        continue;
                    }
                    
                    const page = await pdf.getPage(pageNum);
                    const baseViewport = page.getViewport({ scale: 1 });
                    
                    let scale;
                    if (currentScale === 'auto' || currentScale === 'fit-width') {
                        scale = containerWidth / baseViewport.width;
                    } else if (currentScale === 'fit-page') {
                        const containerHeight = container.clientHeight - 64;
                        const scaleX = containerWidth / baseViewport.width;
                        const scaleY = containerHeight / baseViewport.height;
                        scale = Math.min(scaleX, scaleY);
                    } else {
                        scale = parseFloat(currentScale);
                    }
                    
                    const viewport = page.getViewport({ scale });
                    
                    const pageWrapper = document.createElement('div');
                    pageWrapper.className = 'page-wrapper';
                    pageWrapper.style.width = viewport.width + 'px';
                    pageWrapper.style.height = viewport.height + 'px';
                    pageWrapper.dataset.pageNumber = pageNum;
                    
                    const pageLabel = document.createElement('div');
                    pageLabel.className = 'page-number';
                    pageLabel.textContent = `Á¨¨ ${pageNum} È°µ`;
                    pageWrapper.appendChild(pageLabel);
                    
                    const canvas = document.createElement('canvas');
                    canvas.className = 'page-canvas';
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    pageWrapper.appendChild(canvas);
                    
                    const ctx = canvas.getContext('2d');
                    await page.render({ canvasContext: ctx, viewport }).promise;
                    
                    const textLayer = document.createElement('div');
                    textLayer.className = 'textLayer';
                    textLayer.style.width = viewport.width + 'px';
                    textLayer.style.height = viewport.height + 'px';
                    textLayer.style.setProperty('--scale-factor', scale);
                    pageWrapper.appendChild(textLayer);
                    
                    const textContent = await page.getTextContent();
                    const renderResult = pdfjsLib.renderTextLayer({
                        textContentSource: textContent,
                        container: textLayer,
                        viewport,
                        textDivs: []
                    });
                    
                    if (renderResult && renderResult.promise) {
                        await renderResult.promise;
                    }
                    
                    highlightVocabInPdfTextLayer(textLayer);
                    textLayer.addEventListener('mouseup', showSelectionBubble);
                    
                    const annotationLayer = document.createElement('div');
                    annotationLayer.className = 'annotationLayer';
                    pageWrapper.appendChild(annotationLayer);
                    
                    pagesContainer.appendChild(pageWrapper);
                    
                    // ÊØèÂä†ËΩΩNÈ°µÔºåÊöÇÂÅú‰∏Ä‰∏ãËÆ©ÊµèËßàÂô®ÊúâÊú∫‰ºöÂ§ÑÁêÜÂÖ∂‰ªñ‰ªªÂä°
                    if ((pageNum - startPage + 1) % batchSize === 0) {
                        console.log(`‚úÖ ÂêéÂè∞Â∑≤Âä†ËΩΩÂà∞Á¨¨${pageNum}È°µÔºåÊöÇÂÅú‰∏≠...`);
                        await new Promise(resolve => setTimeout(resolve, 200));  // ‰ªé100msÂ¢ûÂä†Âà∞200ms
                    }
                    
                } catch (e) {
                    console.error(`‚ùå ÂêéÂè∞Âä†ËΩΩÁ¨¨${pageNum}È°µÂ§±Ë¥•:`, e);
                }
            }
            
            console.log(`‚úÖ ÊâÄÊúâ${numPages}È°µÈÉΩÂ∑≤Âä†ËΩΩÂÆåÊàê`);
        }
        
        function updateCurrentPage() {
            const scrollTop = container.scrollTop + container.clientHeight / 2;
            const pages = pagesContainer.querySelectorAll('.page-wrapper');
            
            for (let i = 0; i < pages.length; i++) {
                const page = pages[i];
                const rect = page.getBoundingClientRect();
                const containerRect = container.getBoundingClientRect();
                const pageTop = rect.top - containerRect.top + container.scrollTop;
                const pageBottom = pageTop + rect.height;
                
                if (scrollTop >= pageTop && scrollTop < pageBottom) {
                    document.getElementById('current-page-display').textContent = `È°µ ${i + 1}`;
                    break;
                }
            }
        }
        
        /**
         * ÊªöÂä®Âà∞ÊåáÂÆöÈ°µÁ†ÅÔºàÂ∏¶ÈáçËØïÊú∫Âà∂Â∫îÂØπÂºÇÊ≠•Ê∏≤ÊüìÔºâ
         */
        function scrollToPage(pageNum, retryCount = 0) {
            const pageWrapper = document.querySelector(`[data-page-number="${pageNum}"]`);
            
            if (pageWrapper) {
                // È°µÈù¢Â∑≤Ê∏≤ÊüìÔºåÊªöÂä®Âà∞ËØ•È°µ
                const containerRect = container.getBoundingClientRect();
                const pageRect = pageWrapper.getBoundingClientRect();
                const scrollOffset = pageRect.top - containerRect.top + container.scrollTop;
                
                container.scrollTop = scrollOffset;
                console.log(`‚úÖ Â∑≤ÊªöÂä®Âà∞Á¨¨${pageNum}È°µ`);
                updateCurrentPage();
            } else if (retryCount < 10) {
                // È°µÈù¢ËøòÊú™Ê∏≤ÊüìÔºåÁ≠âÂæÖÂêéÈáçËØï
                console.log(`‚è≥ Á¨¨${pageNum}È°µËøòÊú™Ê∏≤ÊüìÔºå${retryCount + 1}ÁßíÂêéÈáçËØï...`);
                setTimeout(() => {
                    scrollToPage(pageNum, retryCount + 1);
                }, 200);
            } else {
                console.warn(`‚ö†Ô∏è Êó†Ê≥ïÊªöÂä®Âà∞Á¨¨${pageNum}È°µÔºåÈ°µÈù¢ÂèØËÉΩËøòÊú™Âä†ËΩΩ`);
            }
        }
        
        async function loadPDF() {
            document.getElementById('loading').style.display = 'flex';
            
            // ÂÖàÂä†ËΩΩÁîüËØçÊú¨Êï∞ÊçÆÂíåPDFÁºìÂ≠ò
            await loadVocabData();
            const cache = await loadPdfCache();
            const pdfProgress = await loadPdfReadingProgress();
            
            try {
                console.log('‚è≥ ÂºÄÂßãÂä†ËΩΩPDF...');
                const fetchResponse = await fetch(pdfUrl);
                
                if (!fetchResponse.ok) {
                    throw new Error(`HTTP ${fetchResponse.status}: ${fetchResponse.statusText}`);
                }
                
                const arrayBuffer = await fetchResponse.arrayBuffer();
                console.log('‚úì PDFÂ∑≤‰∏ãËΩΩÔºåÂ§ßÂ∞è:', arrayBuffer.byteLength, 'bytes');
                
                const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
                pdf = await loadingTask.promise;
                numPages = pdf.numPages;
                
                document.getElementById('total-pages').textContent = numPages;
                console.log('‚úÖ PDFÂä†ËΩΩÊàêÂäüÔºåÂÖ±', numPages, 'È°µ');
                
                // 1. È¶ñÂÖàÂ∫îÁî®ÁºìÂ≠òÁä∂ÊÄÅÔºàÁº©Êîæ„ÄÅUIÁä∂ÊÄÅÁ≠âÔºâ
                await applyCacheState(cache);
                
                // 2. ÁÑ∂ÂêéÊ∏≤ÊüìÊâÄÊúâÈ°µÈù¢
                console.log('‚è≥ ÂºÄÂßãÊ∏≤ÊüìÊâÄÊúâÈ°µÈù¢...');
                await renderAllPages();
                console.log('‚úÖ ÊâÄÊúâÈ°µÈù¢Ê∏≤ÊüìÂÆåÊàê');
                
                // 3. ÊúÄÂêéÊÅ¢Â§çÈòÖËØªËøõÂ∫¶ÔºàÂøÖÈ°ªÂú®È°µÈù¢Ê∏≤ÊüìÂÆåÊàêÂêéÔºâ
                // ‰ΩøÁî®È°µÁ†ÅÂÆö‰ΩçÔºåÊØîscrollTopÊõ¥ÂèØÈù†
                if (pdfProgress && pdfProgress.currentPage) {
                    const targetPage = pdfProgress.currentPage;
                    console.log('üìñ ÊÅ¢Â§çÈòÖËØªËøõÂ∫¶: Á¨¨', targetPage, 'È°µÔºåËøõÂ∫¶', (pdfProgress.pagePercent || 0).toFixed(1) + '%');
                    
                    // ‰ΩøÁî®requestAnimationFrameÁ°Æ‰øùDOMÂ∑≤Êõ¥Êñ∞
                    requestAnimationFrame(() => {
                        scrollToPage(targetPage);
                    });
                } else {
                    console.log('üìñ Êñ∞ÂºÄÂßãÔºå‰ªéÁ¨¨1È°µÂºÄÂßã');
                    container.scrollTop = 0;
                }
                
                // 4. ÁªüËÆ°PDF‰∏≠ÁöÑÂ≠óÊï∞ÔºàÂª∂ËøüËæÉÈïøÊó∂Èó¥ÔºåÁ≠âÂæÖÂêéÂè∞È°µÈù¢‰πüÊ∏≤ÊüìÂÆåÊàêÔºâ
                setTimeout(() => {
                    countPdfWords();
                }, 5000);  // ‰ªé2ÁßíÂ¢ûÂä†Âà∞5Áßí
                
                // 5. Âë®ÊúüÊÄßÊõ¥Êñ∞Â≠óÊï∞ÁªüËÆ°ÔºåÁõ¥Âà∞Á®≥ÂÆö
                let retryCount = 0;
                const retryInterval = setInterval(() => {
                    const result = countPdfWords();
                    retryCount++;
                    if (retryCount >= 3 || (result.words > 0 && result.chars > 0)) {  // ‰ªé5Ê¨°ÂáèÂ∞ëÂà∞3Ê¨°
                        clearInterval(retryInterval);
                        console.log('‚úÖ Â≠óÊï∞ÁªüËÆ°ÂÆåÊàê');
                    }
                }, 5000);  // ‰ªé3ÁßíÂ¢ûÂä†Âà∞5Áßí
                
                document.getElementById('loading').style.display = 'none';
                
            } catch (e) {
                document.getElementById('loading').style.display = 'none';
                console.error('‚ùå PDFÂä†ËΩΩÂ§±Ë¥•:', e);
                document.getElementById('error').textContent = 'Âä†ËΩΩÂ§±Ë¥•: ' + e.message;
                document.getElementById('error').style.display = 'block';
            }
        }
        
        // ============================================================================
        // PDFËøõÂ∫¶ÂíåÂ≠óÊï∞ÁªüËÆ°‰øùÂ≠ò
        // ============================================================================
        let pdfDocId = getPdfCacheName();  // ‰ΩøÁî®Êñá‰ª∂Âêç‰Ωú‰∏∫ÊñáÊ°£ID
        let pdfProgressTimeout = null;
        let pdfCharCount = 0;  // PDFÊÄªÂ≠óÁ¨¶Êï∞
        let pdfWordCount = 0;  // PDFÊÄªËØçÊï∞
        
        /**
         * ÁªüËÆ°PDF‰∏≠ÁöÑÂ≠óÁ¨¶ÂíåËØçÊï∞
         * ËßÑÂàôÔºö‰∏≠ÊñáÊåâÂ≠óÁ¨¶ËÆ°ÔºåÂÖ∂‰ªñËØ≠Ë®ÄÊåâÁ©∫Ê†ºÂàÜÂâ≤ËÆ°ËØç
         */
        function countPdfWords() {
            let totalChars = 0;
            let totalWords = 0;
            // Âè™ÁªüËÆ°Â∑≤Ê∏≤ÊüìÁöÑÊñáÊú¨Â±Ç‰∏≠ÁöÑÊúâÊïàÊñáÊú¨ËäÇÁÇπÔºàspanÊàñdivÔºâ
            const textDivs = document.querySelectorAll('.textLayer span, .textLayer div');
            
            let validNodeCount = 0;
            textDivs.forEach(div => {
                const text = (div.textContent || '').trim();
                if (!text) return; // Ë∑≥ËøáÁ©∫ÁôΩËäÇÁÇπ
                
                validNodeCount++;
                
                // ÁªüËÆ°‰∏≠ÊñáÂ≠óÁ¨¶
                const chineseMatches = text.match(/[\u4e00-\u9fff\u3400-\u4dbf]/g) || [];
                totalChars += chineseMatches.length;
                
                // ÁªüËÆ°ÂÖ∂‰ªñËØ≠Ë®ÄËØçÔºàÁ©∫Ê†ºÂàÜÂâ≤Ôºâ
                const otherText = text.replace(/[\u4e00-\u9fff\u3400-\u4dbf]/g, '').trim();
                if (otherText) {
                    const words = otherText.split(/\s+/).filter(w => w.length > 0);
                    totalWords += words.length;
                }
            });
            
            pdfCharCount = totalChars;
            pdfWordCount = totalWords;
            console.log(`üìä PDFÂ≠óÊï∞ÁªüËÆ°: ‰∏≠Êñá${totalChars}Â≠ó, ÂÖ∂‰ªñ${totalWords}ËØç (ÊúâÊïàËäÇÁÇπ${validNodeCount}‰∏™)`);
            return { chars: totalChars, words: totalWords };
        }
        
        /**
         * ‰øùÂ≠òPDFÈòÖËØªËøõÂ∫¶Âà∞ÂêéÁ´Ø
         */
        async function savePdfReadingProgress() {
            try {
                const currentPage = parseInt(document.getElementById('current-page-display').textContent.match(/\d+/)?.[0] || 1);
                const scrollPercent = container.scrollHeight > 0 ? (container.scrollTop / (container.scrollHeight - container.clientHeight)) * 100 : 0;
                
                // ‰ª•È°µÁ†Å‰∏∫‰∏ªË¶ÅËøõÂ∫¶‰æùÊçÆÔºàÂΩìÂâçÈ°µÁÆó‰ΩúÂ∑≤ËØªÔºâ
                const pagePercent = numPages > 0 ? (currentPage / numPages) * 100 : 0;
                
                const progressData = {
                    docId: pdfDocId,
                    docType: 'pdf',
                    scrollPosition: container.scrollTop,
                    scrollPercent: Math.min(100, Math.max(0, scrollPercent)),
                    pagePercent: Math.min(100, Math.max(0, pagePercent)),
                    currentPage: currentPage,
                    totalPages: numPages,
                    scale: currentScale,
                    totalChars: pdfCharCount,
                    totalWords: pdfWordCount
                };
                
                const response = await fetch('/api/doc-progress/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(progressData)
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    console.log('üíæ PDFËøõÂ∫¶Â∑≤‰øùÂ≠ò');
                    
                    // ÈÄöÁü•Áà∂Á™óÂè£Êõ¥Êñ∞ËøõÂ∫¶ÊòæÁ§∫
                    try {
                        window.parent.postMessage({
                            type: 'pdfProgressUpdate',
                            progress: {
                                scrollPercent: progressData.scrollPercent,
                                pagePercent: progressData.pagePercent,
                                scrollPosition: progressData.scrollPosition,
                                totalChars: progressData.totalChars,
                                totalWords: progressData.totalWords
                            }
                        }, '*');
                    } catch (e) {
                        console.warn('Êó†Ê≥ïÈÄöÁü•Áà∂Á™óÂè£:', e);
                    }
                }
            } catch (e) {
                console.warn('‚ö†Ô∏è ‰øùÂ≠òPDFËøõÂ∫¶Â§±Ë¥•:', e);
            }
        }
        
        /**
         * Èò≤Êäñ‰øùÂ≠òPDFËøõÂ∫¶
         */
        function debouncedSavePdfProgress() {
            if (pdfProgressTimeout) {
                clearTimeout(pdfProgressTimeout);
            }
            pdfProgressTimeout = setTimeout(() => {
                savePdfReadingProgress();
            }, 1500);
        }
        
        /**
         * Âä†ËΩΩPDFÈòÖËØªËøõÂ∫¶
         */
        async function loadPdfReadingProgress() {
            try {
                const response = await fetch('/api/doc-progress/load', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ docId: pdfDocId })
                });
                
                const result = await response.json();
                if (result.found && result.progress) {
                    console.log('‚úÖ Âä†ËΩΩPDFËøõÂ∫¶ÊàêÂäü');
                    return result.progress;
                }
            } catch (e) {
                console.warn('‚ö†Ô∏è Âä†ËΩΩPDFËøõÂ∫¶Â§±Ë¥•:', e);
            }
            return null;
        }
        
        // ‰∫ã‰ª∂ÁõëÂê¨
        container.addEventListener('scroll', () => {
            updateCurrentPage();
            // Èò≤Êäñ‰øùÂ≠òÁºìÂ≠òÔºàÊØè1Áßí‰øùÂ≠ò‰∏ÄÊ¨°Ôºâ
            debouncedSavePdfCache();
            // Èò≤Êäñ‰øùÂ≠òËøõÂ∫¶ÔºàÊØè1.5Áßí‰øùÂ≠ò‰∏ÄÊ¨°Ôºâ
            debouncedSavePdfProgress();
            // Â§ÑÁêÜÂæÖÂ§ÑÁêÜÁöÑÈ´ò‰∫Æ
            processPendingHighlights();
        });
        
        // Ê∑ªÂä†ÊªöÂä®‰∫ã‰ª∂ÁõëÂê¨Âô®Êù•Â§ÑÁêÜÂä®ÊÄÅÈ´ò‰∫Æ
        container.addEventListener('scroll', processPendingHighlights);
        
        // È°µÈù¢Âç∏ËΩΩÊó∂Á´ãÂç≥‰øùÂ≠òËøõÂ∫¶
        window.addEventListener('beforeunload', () => {
            savePdfReadingProgress();
        });
        
        document.getElementById('zoom-out').onclick = async () => {
            const s = document.getElementById('scale');
            const val = s.value === 'auto' ? 100 : Math.max(50, parseInt(s.value) - 10);
            s.value = val;
            currentScale = val / 100;
            document.getElementById('scale-label').textContent = '%';
            await renderAllPages();
            savePdfCache();  // Áº©ÊîæÊîπÂèòÊó∂‰øùÂ≠òÁºìÂ≠ò
        };
        
        document.getElementById('zoom-in').onclick = async () => {
            const s = document.getElementById('scale');
            const val = s.value === 'auto' ? 120 : Math.min(300, parseInt(s.value) + 10);
            s.value = val;
            currentScale = val / 100;
            document.getElementById('scale-label').textContent = '%';
            await renderAllPages();
            savePdfCache();  // Áº©ÊîæÊîπÂèòÊó∂‰øùÂ≠òÁºìÂ≠ò
        };
        
        document.getElementById('fit-width').onclick = async () => {
            document.getElementById('scale').value = 'auto';
            currentScale = 'fit-width';
            document.getElementById('scale-label').textContent = '(ÈÄÇÂ∫îÂÆΩÂ∫¶)';
            await renderAllPages();
            savePdfCache();  // Áº©ÊîæÊ®°ÂºèÊîπÂèòÊó∂‰øùÂ≠òÁºìÂ≠ò
        };
        
        document.getElementById('fit-page').onclick = async () => {
            document.getElementById('scale').value = 'auto';
            currentScale = 'fit-page';
            document.getElementById('scale-label').textContent = '(ÈÄÇÂ∫îÈ°µÈù¢)';
            await renderAllPages();
            savePdfCache();  // Áº©ÊîæÊ®°ÂºèÊîπÂèòÊó∂‰øùÂ≠òÁºìÂ≠ò
        };
        
        document.getElementById('scale').onchange = async () => {
            const val = document.getElementById('scale').value;
            if (val === 'auto') {
                currentScale = 'fit-width';
                document.getElementById('scale-label').textContent = '(ÈÄÇÂ∫îÂÆΩÂ∫¶)';
            } else {
                currentScale = parseInt(val) / 100;
                document.getElementById('scale-label').textContent = '%';
            }
            await renderAllPages();
            savePdfCache();  // Áº©ÊîæÊîπÂèòÊó∂‰øùÂ≠òÁºìÂ≠ò
        };
        
        // ÈîÆÁõòÂØºËà™
        document.addEventListener('keydown', (e) => {
            if (e.key === 'PageDown' || e.key === 'ArrowDown') {
                container.scrollBy(0, container.clientHeight * 0.9);
                e.preventDefault();
            } else if (e.key === 'PageUp' || e.key === 'ArrowUp') {
                container.scrollBy(0, -container.clientHeight * 0.9);
                e.preventDefault();
            }
        });
        
        loadPDF();
    </script>
</body>
</html>
